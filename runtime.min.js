/*!*
 * @module vow
 * @author Filatov Dmitry <dfilatov@yandex-team.ru>
 * @version 0.4.5
 * @license
 * Dual licensed under the MIT and GPL licenses:
 *   * http://www.opensource.org/licenses/mit-license.php
 *   * http://www.gnu.org/licenses/gpl.html
 */
(function(A){var G=function(){this._promise=new b};G.prototype={promise:function(){return this._promise},resolve:function(a){this._promise.isResolved()||this._promise._resolve(a)},reject:function(a){this._promise.isResolved()||this._promise._reject(a)},notify:function(a){this._promise.isResolved()||this._promise._notify(a)}};var k={PENDING:0,RESOLVED:1,FULFILLED:2,REJECTED:3},b=function(d){this._value=F,this._status=k.PENDING,this._fulfilledCallbacks=[],this._rejectedCallbacks=[],this._progressCallbacks=[];if(d){var a=this,c=d.length;d(function(f){a.isResolved()||a._resolve(f)},c>1?function(f){a.isResolved()||a._reject(f)}:F,c>2?function(f){a.isResolved()||a._notify(f)}:F)}};b.prototype={valueOf:function(){return this._value},isResolved:function(){return this._status!==k.PENDING},isFulfilled:function(){return this._status===k.FULFILLED},isRejected:function(){return this._status===k.REJECTED},then:function(f,h,d,a){var c=new G;return this._addCallbacks(c,f,h,d,a),c.promise()},"catch":function(c,a){return this.then(F,c,a)},fail:function(c,a){return this.then(F,c,a)},always:function(d,a){var f=this,c=function(){return d.call(this,f)};return this.then(c,c,a)},progress:function(c,a){return this.then(F,F,c,a)},spread:function(c,a,d){return this.then(function(e){return c.apply(this,e)},a,d)},done:function(d,a,f,c){this.then(d,a,f,c).fail(z)},delay:function(c){var d,a=this.then(function(f){var e=new G;return d=setTimeout(function(){e.resolve(f)},c),e.promise()});return a.always(function(){clearTimeout(d)}),a},timeout:function(c){var d=new G,a=setTimeout(function(){d.reject(Error("timed out"))},c);return this.then(function(f){d.resolve(f)},function(f){d.reject(f)}),d.promise().always(function(){clearTimeout(a)}),d.promise()},_vow:!0,_resolve:function(h){if(this._status>k.RESOLVED){return}if(h===this){this._reject(TypeError("Can't resolve promise with itself"));return}this._status=k.RESOLVED;if(h&&!!h._vow){h.isFulfilled()?this._fulfill(h.valueOf()):h.isRejected()?this._reject(h.valueOf()):h.then(this._fulfill,this._reject,this._notify,this);return}if(C(h)||w(h)){var c;try{c=h.then}catch(f){this._reject(f);return}if(w(c)){var a=this,d=!1;try{c.call(h,function(i){if(d){return}d=!0,a._resolve(i)},function(i){if(d){return}d=!0,a._reject(i)},function(i){a._notify(i)})}catch(f){d||this._reject(f)}return}}this._fulfill(h)},_fulfill:function(a){if(this._status>k.RESOLVED){return}this._status=k.FULFILLED,this._value=a,this._callCallbacks(this._fulfilledCallbacks,a),this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=F},_reject:function(a){if(this._status>k.RESOLVED){return}this._status=k.REJECTED,this._value=a,this._callCallbacks(this._rejectedCallbacks,a),this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=F},_notify:function(a){this._callCallbacks(this._progressCallbacks,a)},_addCallbacks:function(h,c,f,a,d){f&&!w(f)?(d=f,f=F):a&&!w(a)&&(d=a,a=F);var l;this.isRejected()||(l={defer:h,fn:w(c)?c:F,ctx:d},this.isFulfilled()?this._callCallbacks([l],this._value):this._fulfilledCallbacks.push(l)),this.isFulfilled()||(l={defer:h,fn:f,ctx:d},this.isRejected()?this._callCallbacks([l],this._value):this._rejectedCallbacks.push(l)),this._status<=k.RESOLVED&&this._progressCallbacks.push({defer:h,fn:a,ctx:d})},_callCallbacks:function(f,c){var h=f.length;if(!h){return}var d=this.isResolved(),a=this.isFulfilled();D(function(){var n=0,r,m,i;while(n<h){r=f[n++],m=r.defer,i=r.fn;if(i){var p=r.ctx,e;try{e=p?i.call(p,c):i(c)}catch(t){m.reject(t);continue}d?m.resolve(e):m.notify(e)}else{d?a?m.resolve(c):m.reject(c):m.notify(c)}}})}};var x={cast:function(a){return j.cast(a)},all:function(a){return j.all(a)},race:function(a){return j.anyResolved(a)},resolve:function(a){return j.resolve(a)},reject:function(a){return j.reject(a)}};for(var H in x){x.hasOwnProperty(H)&&(b[H]=x[H])}var j={Deferred:G,Promise:b,defer:function(){return new G},when:function(f,c,h,d,a){return j.cast(f).then(c,h,d,a)},fail:function(c,a,d){return j.when(c,F,a,d)},always:function(c,a,d){return j.when(c).always(a,d)},progress:function(c,a,d){return j.when(c).progress(a,d)},spread:function(d,a,f,c){return j.when(d).spread(a,f,c)},done:function(f,c,h,d,a){j.when(f).done(c,h,d,a)},isPromise:function(a){return C(a)&&w(a.then)},cast:function(a){return j.isPromise(a)?a:j.resolve(a)},valueOf:function(a){return a&&w(a.valueOf)?a.valueOf():a},isFulfilled:function(a){return a&&w(a.isFulfilled)?a.isFulfilled():!0},isRejected:function(a){return a&&w(a.isRejected)?a.isRejected():!1},isResolved:function(a){return a&&w(a.isResolved)?a.isResolved():!0},resolve:function(c){var a=j.defer();return a.resolve(c),a.promise()},fulfill:function(c){var a=j.defer(),d=a.promise();return a.resolve(c),d.isFulfilled()?d:d.then(null,function(f){return f})},reject:function(c){if(j.isPromise(c)){return c.then(function(f){var d=j.defer();return d.reject(f),d.promise()})}var a=j.defer();return a.reject(c),a.promise()},invoke:function(d,h){var f=Math.max(arguments.length-1,0),c;if(f){c=Array(f);var e=0;while(e<f){c[e++]=arguments[e]}}try{return j.resolve(c?d.apply(A,c):d.call(A))}catch(a){return j.reject(a)}},all:function(m){var o=new G,l=g(m),f=l?B(m):E(m),h=f.length,d=l?[]:{};if(!h){return o.resolve(d),o.promise()}var c=h;return j._forEach(m,function(){if(!--c){var a=0;while(a<h){d[f[a]]=j.valueOf(m[f[a++]])}o.resolve(d)}},o.reject,o.notify,o,f),o.promise()},allResolved:function(m){var o=new G,l=g(m),f=l?B(m):E(m),h=f.length,d=l?[]:{};if(!h){return o.resolve(d),o.promise()}var c=function(){--h||o.resolve(m)};return j._forEach(m,c,c,o.notify,o,f),o.promise()},allPatiently:function(a){return j.allResolved(a).then(function(){var h=g(a),p=h?B(a):E(a),m,e,l=p.length,d=0,c,o;if(!l){return h?[]:{}}while(d<l){c=p[d++],o=a[c],j.isRejected(o)?(m||(m=h?[]:{}),h?m.push(o.valueOf()):m[c]=o.valueOf()):m||((e||(e=h?[]:{}))[c]=j.valueOf(o))}if(m){throw m}return e})},any:function(f){var h=new G,d=f.length;if(!d){return h.reject(Error()),h.promise()}var a=0,c;return j._forEach(f,h.resolve,function(i){a||(c=i),++a===d&&h.reject(c)},h.notify,h),h.promise()},anyResolved:function(c){var d=new G,a=c.length;return a?(j._forEach(c,d.resolve,d.reject,d.notify,d),d.promise()):(d.reject(Error()),d.promise())},delay:function(c,a){return j.resolve(c).delay(a)},timeout:function(c,a){return j.resolve(c).timeout(a)},_forEach:function(o,h,p,m,f,l){var d=l?l.length:o.length,c=0;while(c<d){j.when(o[l?l[c]:c],h,p,m,f),++c}}},F,D=function(){var v=[],e=function(a){return v.push(a)===1},c=function(){var f=v,i=0,a=v.length;v=[];while(i<a){f[i++]()}};if(typeof setImmediate=="function"){return function(a){e(a)&&setImmediate(c)}}if(typeof process=="object"&&process.nextTick){return function(a){e(a)&&process.nextTick(c)}}if(A.postMessage){var h=!0;if(A.attachEvent){var I=function(){h=!1};A.attachEvent("onmessage",I),A.postMessage("__checkAsync","*"),A.detachEvent("onmessage",I)}if(h){var d="__promise"+ +(new Date),p=function(a){a.data===d&&(a.stopPropagation&&a.stopPropagation(),c())};return A.addEventListener?A.addEventListener("message",p,!0):A.attachEvent("onmessage",p),function(a){e(a)&&A.postMessage(d,"*")}}}var m=A.document;if("onreadystatechange" in m.createElement("script")){var l=function(){var a=m.createElement("script");a.onreadystatechange=function(){a.parentNode.removeChild(a),a=a.onreadystatechange=null,c()},(m.documentElement||m.body).appendChild(a)};return function(a){e(a)&&l()}}return function(a){e(a)&&setTimeout(c,0)}}(),z=function(a){D(function(){throw a})},w=function(a){return typeof a=="function"},C=function(a){return a!==null&&typeof a=="object"},y=Object.prototype.toString,g=Array.isArray||function(a){return y.call(a)==="[object Array]"},B=function(d){var a=[],f=0,c=d.length;while(f<c){a.push(f++)}return a},E=Object.keys||function(c){var a=[];for(var d in c){c.hasOwnProperty(d)&&a.push(d)}return a},q=!0;typeof exports=="object"&&(module.exports=j,q=!1),typeof modules=="object"&&(modules.define("vow",function(a){a(j)}),q=!1),typeof define=="function"&&(define(function(c,a,d){d.exports=j}),q=!1),q&&(A.vow=j)})(this);
/*!*
 * asjs
 * Copyright (c) 2013 Anton A. Drachev anton@drachev.com
 * Licensed under the BSD 2-Clause License:
 * https://github.com/omgtehlion/asjs/raw/master/license.txt
 */
(function(){function a(d){return d&&typeof(d.then)==="function"}var c={};var b=function(){this.machine=null;this.handlers=null;this.deferred=Vow.defer();this.exited=false;this.val=undefined;this.CONT=c};b.prototype.run=function(e,d){this.machine=e;this.handlers=d;this.next();return this.deferred.promise()};b.prototype.ret=function(d){if(this.exited){throw"Internal error: this method already exited"}this.deferred.resolve(d);this.dispose()};b.prototype.setException=function(d){if(this.handlers&&this.handlers(d)===c){this.next()}else{this.deferred.reject(d);this.dispose()}};b.prototype.dispose=function(){this.exited=true;this.machine=null;this.handlers=null;this.val=undefined};b.prototype.onFulfill=function(d){this.val=d;this.next()};b.prototype.onReject=b.prototype.setException;b.prototype.setupThen=function(e){var d=this;e.then(function(f){d.onFulfill(f)},function(f){d.onReject(f)})};b.prototype.next=function(){var d=c;while(!this.exited&&d===c){try{d=this.machine()}catch(e){this.setException(e);break}this.val=undefined;if(d instanceof Vow.Promise){if(d.isFulfilled()){this.val=d.valueOf();d=c}else{d.then(this.onFulfill,this.onReject,undefined,this);break}}else{if(a(d)){this.setupThen(d);break}else{if(d!==c&&!this.exited){this.setException("Awaited value is not a promise: "+d);break}}}}};this.compilerSupport={TaskBuilder:b}})();
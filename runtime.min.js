/**
 * Vow
 *
 * Copyright (c) 2012-2013 Filatov Dmitry (dfilatov@yandex-team.ru)
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 * @version 0.3.12
 */
(function(q){var y=function(a){this._res=a,this._isFulfilled=!!arguments.length,this._isRejected=!1,this._fulfilledCallbacks=[],this._rejectedCallbacks=[],this._progressCallbacks=[]};y.prototype={valueOf:function(){return this._res},isFulfilled:function(){return this._isFulfilled},isRejected:function(){return this._isRejected},isResolved:function(){return this._isFulfilled||this._isRejected},fulfill:function(a){if(this.isResolved()){return}this._isFulfilled=!0,this._res=a,this._callCallbacks(this._fulfilledCallbacks,a),this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=b},reject:function(a){if(this.isResolved()){return}this._isRejected=!0,this._res=a,this._callCallbacks(this._rejectedCallbacks,a),this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=b},notify:function(a){if(this.isResolved()){return}this._callCallbacks(this._progressCallbacks,a)},then:function(o,r,h,l){r&&!d(r)?(l=r,r=b):h&&!d(h)&&(l=h,h=b);var f=new y,c;return this._isRejected||(c={promise:f,fn:d(o)?o:b,ctx:l},this._isFulfilled?this._callCallbacks([c],this._res):this._fulfilledCallbacks.push(c)),this._isFulfilled||(c={promise:f,fn:r,ctx:l},this._isRejected?this._callCallbacks([c],this._res):this._rejectedCallbacks.push(c)),this.isResolved()||this._progressCallbacks.push({promise:f,fn:h,ctx:l}),f},fail:function(c,a){return this.then(b,c,a)},always:function(f,a){var h=this,c=function(){return f.call(this,h)};return this.then(c,c,a)},progress:function(c,a){return this.then(b,b,c,a)},spread:function(c,a,f){return this.then(function(e){return c.apply(this,e)},a,f)},done:function(f,a,h,c){this.then(f,a,h,c).fail(z)},delay:function(c){var f,a=this.then(function(h){var e=new y;return f=setTimeout(function(){e.fulfill(h)},c),e});return a.always(function(){clearTimeout(f)}),a},timeout:function(c){var f=new y,a=setTimeout(function(){f.reject(Error("timed out"))},c);return f.sync(this),f.always(function(){clearTimeout(a)}),f},sync:function(a){a.then(this.fulfill,this.reject,this.notify,this)},_callCallbacks:function(h,a){var f=h.length;if(!f){return}var c=this.isResolved(),i=this.isFulfilled();k(function(){var r=0,o,n,t;while(r<f){o=h[r++],n=o.promise,t=o.fn;if(t){var e=o.ctx,A;try{A=e?t.call(e,a):t(a)}catch(s){n.reject(s);continue}c?g.isPromise(A)?function(l){A.then(function(u){l.fulfill(u)},function(u){l.reject(u)},function(u){l.notify(u)})}(n):n.fulfill(A):n.notify(A)}else{c?i?n.fulfill(a):n.reject(a):n.notify(a)}}})}};var g={Promise:y,promise:function(a){return arguments.length?g.isPromise(a)?a:new y(a):new y},when:function(l,c,h,a,f){return g.promise(l).then(c,h,a,f)},fail:function(f,c,a){return g.when(f,b,c,a)},always:function(f,a,c){return g.promise(f).always(a,c)},progress:function(f,a,c){return g.promise(f).progress(a,c)},spread:function(h,c,f,a){return g.promise(h).spread(c,f,a)},done:function(l,c,h,a,f){g.promise(l).done(c,h,a,f)},isPromise:function(a){return a&&d(a.then)},valueOf:function(a){return g.isPromise(a)?a.valueOf():a},isFulfilled:function(a){return g.isPromise(a)?a.isFulfilled():!0},isRejected:function(a){return g.isPromise(a)?a.isRejected():!1},isResolved:function(a){return g.isPromise(a)?a.isResolved():!0},fulfill:function(a){return g.when(a,b,function(c){return c})},reject:function(a){return g.when(a,function(c){var f=new y;return f.reject(c),f})},resolve:function(a){return g.isPromise(a)?a:g.when(a)},invoke:function(a){try{return g.promise(a.apply(q,x.call(arguments,1)))}catch(c){return g.reject(c)}},forEach:function(l,c,h,a){var f=a?a.length:l.length,n=0;while(n<f){g.when(l[a?a[n]:n],c,h),++n}},all:function(A){var c=new y,n=p(A),D=n?j(A):v(A),l=D.length,C=n?[]:{};if(!l){return c.fulfill(C),c}var B=l,t=function(){if(!--B){var a=0;while(a<l){C[D[a]]=g.valueOf(A[D[a++]])}c.fulfill(C)}},f=function(a){c.reject(a)};return g.forEach(A,t,f,D),c},allResolved:function(t){var n=new y,h=p(t),l=h?j(t):v(t),A=l.length,f=h?[]:{};if(!A){return n.fulfill(f),n}var c=function(){--A||n.fulfill(t)};return g.forEach(t,c,c,l),n},allPatiently:function(a){return g.allResolved(a).then(function(){var l=p(a),B=l?j(a):v(a),f,A,C=B.length,e=0,c,n;if(!C){return l?[]:{}}while(e<C){c=B[e++],n=a[c],g.isRejected(n)?(f||(f=l?[]:{}),l?f.push(n.valueOf()):f[c]=n.valueOf()):f||((A||(A=l?[]:{}))[c]=g.valueOf(n))}if(f){throw f}return A})},any:function(t){var n=new y,h=t.length;if(!h){return n.reject(Error()),n}var l=0,A,f=function(a){n.fulfill(a)},c=function(a){l||(A=a),++l===h&&n.reject(A)};return g.forEach(t,f,c),n},delay:function(c,a){return g.promise(c).delay(a)},timeout:function(c,a){return g.promise(c).timeout(a)}},b,k=function(){var D=[],h=function(a){return D.push(a)===1},c=function(){var f=D,i=0,a=D.length;D=[];while(i<a){f[i++]()}};if(typeof setImmediate=="function"){return function(a){h(a)&&setImmediate(c)}}if(typeof process=="object"&&process.nextTick){return function(a){h(a)&&process.nextTick(c)}}if(q.postMessage){var l=!0;if(q.attachEvent){var E=function(){l=!1};q.attachEvent("onmessage",E),q.postMessage("__checkAsync","*"),q.detachEvent("onmessage",E)}if(l){var e="__promise"+ +(new Date),C=function(a){a.data===e&&(a.stopPropagation&&a.stopPropagation(),c())};return q.addEventListener?q.addEventListener("message",C,!0):q.attachEvent("onmessage",C),function(a){h(a)&&q.postMessage(e,"*")}}}var B=q.document;if("onreadystatechange" in B.createElement("script")){var A=function(){var a=B.createElement("script");a.onreadystatechange=function(){a.parentNode.removeChild(a),a=a.onreadystatechange=null,c()},(B.documentElement||B.body).appendChild(a)};return function(a){h(a)&&A()}}return function(a){h(a)&&setTimeout(c,0)}}(),z=function(a){k(function(){throw a})},d=function(a){return typeof a=="function"},x=Array.prototype.slice,w=Object.prototype.toString,p=Array.isArray||function(a){return w.call(a)==="[object Array]"},j=function(f){var a=[],h=0,c=f.length;while(h<c){a.push(h++)}return a},v=Object.keys||function(c){var a=[];for(var f in c){c.hasOwnProperty(f)&&a.push(f)}return a},m=!0;typeof exports=="object"&&(module.exports=g,m=!1),typeof modules=="object"&&(modules.define("vow",function(a){a(g)}),m=!1),typeof define=="function"&&(define(function(f,a,c){c.exports=g}),m=!1),m&&(q.Vow=g)})(this);
/**
 * asjs
 * Copyright (c) 2013 Anton A. Drachev anton@drachev.com
 * Licensed under the BSD 2-Clause License:
 * https://github.com/omgtehlion/asjs/raw/master/license.txt
 */
(function(){function a(d){return d&&typeof(d.then)==="function"}var c={};var b=function(){this.machine=null;this.handlers=null;this.promise=Vow.promise();this.exited=false;this.val=undefined;this.CONT=c};b.prototype.run=function(e,d){this.machine=e;this.handlers=d;this.next();return this.promise};b.prototype.ret=function(d){if(this.exited){throw"Internal error: this method already exited"}this.promise.fulfill(d);this.dispose()};b.prototype.setException=function(d){if(this.handlers&&this.handlers(d)===c){this.next()}else{this.promise.reject(d);this.dispose()}};b.prototype.dispose=function(){this.exited=true;this.machine=null;this.handlers=null;this.val=undefined};b.prototype.onFulfill=function(d){this.val=d;this.next()};b.prototype.onReject=b.prototype.setException;b.prototype.next=function(){var d=c;while(!this.exited&&d===c){try{d=this.machine()}catch(e){this.setException(e);break}if(a(d)){if(d._isFulfilled){this.val=d.valueOf();d=c}else{this.val=undefined;d.then(this.onFulfill,this.onReject,undefined,this);break}}else{if(d!==c&&!this.exited){this.setException("Awaited value is not a promise: "+d);break}}}};this.compilerSupport={TaskBuilder:b}})();